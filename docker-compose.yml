version: '3.8'

services:
  # ==================== 应用服务 ====================
  app:
    # 使用 DockerHub 镜像（推荐，快速部署）
    image: kokojacket/panbox-search:latest

    # 如果需要本地构建，注释掉上面的 image，取消注释下面的 build
    # build:
    #   context: .
    #   dockerfile: Dockerfile

    container_name: panbox-search-app

    # 端口映射 - 可以通过 .env 文件修改，或使用默认值 80
    ports:
      - "${APP_PORT:-80}:80"

    # 环境变量配置（使用固定值，自动安装）
    environment:
      # 数据库连接（固定配置）
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=panbox-search
      - DB_USER=panbox-search
      - DB_PASSWORD=panbox-search
      - DB_PREFIX=qf_

      # 应用配置（固定配置）
      - APP_DEBUG=false
      - APP_TIMEZONE=Asia/Shanghai
      - SYSTEM_SALT=Panbox Search

      # 网站名称（可在后台修改）
      - SITE_NAME=Panbox Search

    # 数据持久化
    volumes:
      # 运行时目录（缓存、日志等）
      - /opt/panbox-search/app/runtime:/var/www/html/runtime
      # 上传文件目录
      - /opt/panbox-search/app/uploads:/var/www/html/public/uploads
      # 安装目录（保存安装锁文件）
      - /opt/panbox-search/app/install:/var/www/html/public/install

    # 依赖服务
    depends_on:
      - mysql

    # 网络配置
    networks:
      - panbox-search-network

    # 重启策略
    restart: unless-stopped

  # ==================== MySQL 数据库 ====================
  mysql:
    image: mysql:5.7
    container_name: panbox-search-mysql

    # 端口映射（如果不需要外部访问可以注释掉）
    # ports:
    #   - "3306:3306"

    # 环境变量（固定配置）
    environment:
      - MYSQL_ROOT_PASSWORD=panbox-search
      - MYSQL_DATABASE=panbox-search
      - MYSQL_USER=panbox-search
      - MYSQL_PASSWORD=panbox-search
      - TZ=Asia/Shanghai

    # 数据持久化
    volumes:
      # MySQL 数据目录
      - /opt/panbox-search/mysql:/var/lib/mysql

    # 网络配置
    networks:
      - panbox-search-network

    # 重启策略
    restart: unless-stopped

    # 性能优化
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
      - --max_connections=1000
      - --max_allowed_packet=128M

# ==================== 网络配置 ====================
networks:
  panbox-search-network:
    driver: bridge

# ==================== 数据卷配置 ====================
volumes:
  mysql-data:
    driver: local
